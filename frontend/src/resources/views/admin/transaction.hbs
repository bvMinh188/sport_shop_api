<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="card-title mb-0">Thông Tin Đơn Hàng</h3>
                        {{#if totalPages}}
                        <nav aria-label="Page navigation" class="mb-0">
                            <ul class="pagination mb-0">
                                <li class="page-item {{#if (eq currentPage 1)}}disabled{{/if}}">
                                    <a class="page-link" href="?page={{subtract currentPage 1}}" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                {{#times totalPages}}
                                <li class="page-item {{#if (eq this ../currentPage)}}active{{/if}}">
                                    <a class="page-link" href="?page={{this}}">{{this}}</a>
                                </li>
                                {{/times}}
                                <li class="page-item {{#if (eq currentPage totalPages)}}disabled{{/if}}">
                                    <a class="page-link" href="?page={{add currentPage 1}}" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                        {{/if}}
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
        <thead>
            <tr>
                                    <th style="width: 5%">STT</th>
                                    <th style="width: 15%">Tên khách hàng</th>
                                    <th style="width: 20%">Địa chỉ</th>
                                    <th style="width: 10%">Số điện thoại</th>
                                    <th style="width: 10%">Giá</th>
                                    <th style="width: 15%">Thời gian</th>
                                    <th style="width: 12%">Trạng thái</th>
                                    <th style="width: 13%">Thao tác</th>
            </tr>
        </thead>
        <tbody>
                                {{#each orders}}
                <tr>
                                    <td class="text-center">{{sum @index 1}}</td>
                                    <td>{{this.customerName}}</td>
                                    <td class="address-cell" title="{{this.address}}">{{this.address}}</td>
                                    <td class="text-center">{{this.phone}}</td>
                                    <td class="text-end">{{this.price}}</td>
                                    <td class="text-center">{{formatDate this.createdAt}}</td>
                                    <td class="text-center">
                                        <span class="badge rounded-pill {{#if (eq this.status 'chờ xác nhận')}}bg-warning{{/if}}
                                            {{#if (eq this.status 'đang giao')}}bg-primary{{/if}}
                                            {{#if (eq this.status 'đã giao')}}bg-success{{/if}}
                                            {{#if (eq this.status 'đã hủy')}}bg-danger{{/if}}">
                                            {{this.status}}
                                        </span>
                                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" 
                                data-bs-target="#detail-order-modal" 
                                data-order='{{{json this}}}'>
                            Xem
                            </button>

                        {{#if (eq this.status "chờ xác nhận")}}
                                <button class="btn btn-success btn-sm btn-confirm" data-id="{{this._id}}">
                                    Xác nhận
                                </button>
                                <button class="btn btn-danger btn-sm" data-bs-toggle="modal" 
                                    data-id="{{this._id}}" data-bs-target="#delete-order-modal">
                                    Hủy
                                </button>
                        {{/if}}

                        {{#if (eq this.status "đang giao")}}
                                <button class="btn btn-success btn-sm btn-complete" data-id="{{this._id}}">
                                    Hoàn thành
                                </button>
                        {{/if}}
                        </div>
                    </td>
                </tr>
            {{/each}}
        </tbody>
    </table>
</div>

                    {{#unless orders.length}}
                    <div class="alert alert-info text-center mt-3">
                        <i class="fas fa-info-circle me-2"></i>Không tìm thấy đơn hàng nào.
                    </div>
                    {{/unless}}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Chi tiết đơn hàng -->
<div id="detail-order-modal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chi tiết đơn hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
                <div class="order-info mb-4">
                    <h6 class="border-bottom pb-2">Thông tin khách hàng</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Tên khách hàng:</strong> <span id="customer-name"></span></p>
                            <p><strong>Số điện thoại:</strong> <span id="customer-phone"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Địa chỉ:</strong> <span id="customer-address"></span></p>
                            <p><strong>Tổng tiền:</strong> <span id="order-total"></span></p>
                        </div>
                    </div>
                </div>
                <div class="order-products">
                    <h6 class="border-bottom pb-2">Danh sách sản phẩm</h6>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>Tên sản phẩm</th>
                                    <th>Size</th>
                                    <th>Số lượng</th>
                                </tr>
                            </thead>
                            <tbody id="order-products">
                            </tbody>
                        </table>
                    </div>
                </div>
      </div>
      <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Xác Nhận Hủy -->
<div id="delete-order-modal" class="modal fade" tabindex="-1">
    <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
                <h5 class="modal-title">Xác nhận hủy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Bạn có chắc chắn muốn hủy đơn hàng này không?</p>
                <p class="text-danger">Hành động này không thể hoàn tác.</p>
      </div>
            <div class="modal-footer" style="justify-content: center; gap: 10px;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="min-width: 100px;">Không</button>
                <button id="btn-delete-order" type="button" class="btn btn-danger" style="min-width: 100px;">Xác nhận</button>
      </div>
    </div>
  </div>
</div>

{{!-- Form Ẩn --}}
<form name="delete-order-form" method="POST" action="" class="d-none">
    <input type="hidden" name="_method" value="DELETE">
</form>

{{!-- Form xác nhận --}}
<form name="confirm-order-form" method="POST" action="" class="d-none">
    <input type="hidden" name="_method" value="PATCH">
</form>

{{!-- Form hoàn thành --}}
<form name="complete-order-form" method="POST" action="" class="d-none">
    <input type="hidden" name="_method" value="PATCH">
</form>

<style>
.action-buttons {
    display: flex;
    gap: 5px;
    justify-content: center;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
}

.table th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    vertical-align: middle;
}

.table td {
    vertical-align: middle;
    padding: 0.5rem;
}

.address-cell {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.badge {
    font-weight: 500;
    padding: 0.5em 0.75em;
}

.modal-content {
    border-radius: 8px;
}

.modal-header, .modal-footer {
    padding: 1rem;
}

.modal-body {
    padding: 1rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Xử lý modal xem chi tiết đơn hàng
    $('#detail-order-modal').on('show.bs.modal', function (event) {
        try {
        const button = $(event.relatedTarget);
            const orderData = button.data('order');

            // Hiển thị thông tin đơn hàng
            $('#customer-name').text(orderData.customerName || 'N/A');
            $('#customer-phone').text(orderData.phone || 'N/A');
            $('#customer-address').text(orderData.address || 'N/A');
            $('#order-total').text(orderData.price );

            // Hiển thị danh sách sản phẩm
            const orderProductsContainer = document.getElementById('order-products');
            orderProductsContainer.innerHTML = '';
            
            if (Array.isArray(orderData.products)) {
                orderData.products.forEach((product, index) => {
                    const row = `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${product.name || 'N/A'}</td>
                            <td>${product.size || 'N/A'}</td>
                            <td>${product.quantity || '0'}</td>
                        </tr>`;
                    orderProductsContainer.insertAdjacentHTML('beforeend', row);
                });
            } else {
                orderProductsContainer.innerHTML = '<tr><td colspan="4" class="text-center">Không có sản phẩm nào</td></tr>';
            }
        } catch (error) {
            alert('Có lỗi xảy ra khi hiển thị chi tiết đơn hàng');
        }
    });

    // Xử lý nút xác nhận đơn hàng
    $('.btn-confirm').click(function(event) {
        event.preventDefault();
        const orderId = $(this).data('id');
        const form = document.forms['confirm-order-form'];
        form.action = '/admin/order/' + orderId + '/confirm?_method=PATCH';
        form.submit();
    });

    // Xử lý nút hoàn thành đơn hàng
    $('.btn-complete').click(function(event) {
        event.preventDefault();
        const orderId = $(this).data('id');
        const form = document.forms['complete-order-form'];
        form.action = '/admin/order/' + orderId + '/complete?_method=PATCH';
        form.submit();
    });

    // Xử lý nút hủy đơn hàng
    $('#delete-order-modal').on('show.bs.modal', function(event) {
        const button = $(event.relatedTarget);
        const orderId = button.data('id');
        const form = document.forms['delete-order-form'];
        
        $('#btn-delete-order').off('click').on('click', function() {
            form.action = '/admin/order/' + orderId + '?_method=DELETE';
            form.submit();
    });
});
});</script>
