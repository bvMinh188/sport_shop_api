<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="card-title mb-0">Thông Tin Người Dùng</h3>
                        {{#if totalPages}}
                        <nav aria-label="Page navigation" class="mb-0">
                            <ul class="pagination mb-0">
                                <li class="page-item {{#if (eq currentPage 1)}}disabled{{/if}}">
                                    <a class="page-link" href="?page={{subtract currentPage 1}}" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                {{#times totalPages}}
                                <li class="page-item {{#if (eq this ../currentPage)}}active{{/if}}">
                                    <a class="page-link" href="?page={{this}}">{{this}}</a>
                                </li>
                                {{/times}}
                                <li class="page-item {{#if (eq currentPage totalPages)}}disabled{{/if}}">
                                    <a class="page-link" href="?page={{add currentPage 1}}" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                        {{/if}}
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 5%">STT</th>
                                    <th style="width: 20%">Tên người dùng</th>
                                    <th style="width: 25%">Email</th>
                                    <th style="width: 10%">Vai trò</th>
                                    <th style="width: 20%">Ngày tạo</th>
                                    <th style="width: 20%">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each users.data.users}}
                                <tr>
                                    <td class="text-center">{{sum @index 1}}</td>
                                    <td>{{this.username}}</td>
                                    <td>{{this.email}}</td>
                                    <td class="text-center">
                                        <span class="badge rounded-pill {{#if (eq this.role 'admin')}}bg-danger{{else}}bg-primary{{/if}}">
                                            {{this.role}}
                                        </span>
                                    </td>
                                    <td class="text-center">{{formatDate this.createdAt}}</td>
                                    <td>
                                        <div class="action-buttons">
                                            <a href="/admin/users/edit/{{this._id}}" class="btn btn-success btn-sm">
                                                <i class="fas fa-edit"></i> Sửa
                                            </a>
                                            <button type="button" class="btn btn-danger btn-sm" onclick="openDeleteModal('{{this._id}}', '{{this.username}}')">
                                                <i class="fas fa-trash"></i> Xóa
                                            </button>
                                        </div>

                                        <!-- Modal Xác Nhận Xóa cho từng user -->
                                        <div class="modal fade" id="delete-user-modal-{{this._id}}" tabindex="-1">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title">Xác nhận xóa</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="confirm-message">
                                                            <div class="alert alert-warning mb-0">
                                                            Bạn có chắc chắn muốn xóa người dùng <strong>{{this.username}}</strong>?
                                                            </div>
                                                        </div>
                                                        <div id="message-container-{{this._id}}">
                                                            <!-- Messages will be inserted here -->
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer" style="justify-content: center; gap: 10px;">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="min-width: 100px;">Không</button>
                                                        <button type="button" class="btn btn-danger" id="confirm-delete-{{this._id}}" style="min-width: 100px;">Có</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                const confirmDeleteBtn = document.getElementById('confirm-delete-{{this._id}}');
                                if (confirmDeleteBtn) {
                                    confirmDeleteBtn.onclick = async function() {
                                        const token = localStorage.getItem('token');
                                        const userId = '{{this._id}}';
                                        
                                        try {
                                            const response = await fetch(`http://localhost:3000/api/users/${userId}`, {
                                                method: 'DELETE',
                                                headers: {
                                                    'Authorization': `Bearer ${token}`
                                                },
                                                credentials: 'include'
                                            });
                                            
                                            const result = await response.json();
                                            
                                            if (result.success) {
                                                // Hiển thị thông báo thành công
                                                const messageContainer = document.getElementById('message-container-{{this._id}}');
                                                messageContainer.innerHTML = `
                                                    <div class="alert alert-success">
                                                        ${result.message}
                                                    </div>
                                                `;
                                                
                                                // Tự động đóng modal sau 2 giây
                                                setTimeout(() => {
                                                    const modal = bootstrap.Modal.getInstance(document.getElementById('delete-user-modal-{{this._id}}'));
                                                    if (modal) {
                                                        modal.hide();
                                                    }
                                                }, 2000);
                                            } else {
                                                // Hiển thị thông báo lỗi
                                                const messageContainer = document.getElementById('message-container-{{this._id}}');
                                                messageContainer.innerHTML = `
                                                    <div class="alert alert-danger">
                                                        ${result.message}
                                                    </div>
                                                `;
                                            }
                                        } catch (error) {
                                            console.error('Error deleting user:', error);
                                            const messageContainer = document.getElementById('message-container-{{this._id}}');
                                            messageContainer.innerHTML = `
                                                <div class="alert alert-danger">
                                                    Có lỗi xảy ra khi xóa người dùng
                                                </div>
                                            `;
                                        }
                                    };
                                }
                            });
                        </script>
                        <script>
                            function openDeleteModal(userId, userName) {
                                const modal = new bootstrap.Modal(document.getElementById(`delete-user-modal-${userId}`));
                                const messageContainer = document.getElementById(`message-container-${userId}`);
                                messageContainer.innerHTML = '';
                                
                                // Cập nhật tên user trong modal
                                const confirmMessage = document.querySelector(`#delete-user-modal-${userId} .confirm-message`);
                                if (confirmMessage) {
                                    confirmMessage.innerHTML = `
                                        <div class="alert alert-warning mb-0">
                                            Bạn có chắc chắn muốn xóa người dùng <strong>${userName}</strong>?
                                        </div>
                                    `;
                                }
                                
                                modal.show();
                            }
                        </script>
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.action-buttons {
    display: flex;
    gap: 5px;
    justify-content: center;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
}

.table th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    vertical-align: middle;
}

.table td {
    vertical-align: middle;
    padding: 0.5rem;
}

.badge {
    font-weight: 500;
    padding: 0.5em 0.75em;
}

/* Style cho modal */
.modal-content {
    border-radius: 8px;
    border: none;
}

.modal-header {
    border-bottom: 1px solid #dee2e6;
    padding: 1rem;
}

.modal-body {
    padding: 1rem;
}

.modal-footer {
    border-top: 1px solid #dee2e6;
    padding: 1rem;
}

.btn {
    border-radius: 4px;
    font-weight: 500;
}

.btn i {
    margin-right: 5px;
}

/* Style cho phân trang */
.pagination {
    margin-bottom: 0;
}

.page-link {
    padding: 0.375rem 0.75rem;
}

.page-item.active .page-link {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.alert {
    margin-bottom: 1rem;
}

.alert:last-child {
    margin-bottom: 0;
}

.d-none {
    display: none !important;
}

.modal-body .confirm-message {
    margin-bottom: 1rem;
}

.spinner-border {
    width: 1rem;
    height: 1rem;
    margin-right: 0.5rem;
}

.btn:disabled {
    cursor: not-allowed;
    opacity: 0.65;
}
</style>

<script>
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

document.addEventListener('DOMContentLoaded', function() {
    fetchUsers();
});

async function fetchUsers() {
    try {
        const token = getCookie('token');
        const response = await fetch('http://localhost:3000/api/allusers', {
            headers: {
                'Authorization': `Bearer ${token}`
            },
            credentials: 'include'
        });
        const data = await response.json();
        if (data.success) {
            // Update the table with new data
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = '';
            
            data.data.users.forEach((user, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td class="text-center">${user.role || 'user'}</td>
                    <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-2">Sửa</button>
                        <button class="btn btn-sm btn-danger">Xóa</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
    } catch (error) {
        console.error('Error fetching users:', error);
        alert('Có lỗi khi tải danh sách người dùng');
    }
}
</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
