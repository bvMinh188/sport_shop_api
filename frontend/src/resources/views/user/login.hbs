<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng Nhập</title>
    <link rel="stylesheet" href="/css/auth.css">
</head>
<body class="auth-page">
    <div class="auth-container">
        <h2>Đăng Nhập</h2>
        <div id="message" class="alert"></div>

        <form id="form-login">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" class="form-control" id="email" name="email" placeholder="nva@gmail.com" required>
            </div>
            <div class="form-group">
                <label for="password">Mật khẩu</label>
                <input type="password" class="form-control" id="password" name="password" placeholder="*****" required>
            </div>
            <button type="submit" class="btn-primary">Đăng nhập</button>
            <div class="auth-links">
                <p>Chưa có tài khoản? <a href="/auth/register">Đăng ký ngay</a></p>
                <p><a href="/auth/forgot-password">Quên mật khẩu?</a></p>
            </div>
        </form>
    </div>

    <!-- Add jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        $(document).ready(function () {
            // Hàm set cookie với các options bảo mật
            function setCookie(name, value, days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                const expires = "expires=" + date.toUTCString();
                document.cookie = `${name}=${value}; ${expires}; path=/; SameSite=Lax`;
            }

            function showMessage(message, type) {
                const messageDiv = $("#message");
                messageDiv.removeClass("alert-danger alert-success")
                    .addClass(type === "error" ? "alert-danger" : "alert-success")
                    .text(message)
                    .show();
                setTimeout(() => {
                    messageDiv.fadeOut();
                }, 3000);
            }

            $("#form-login").submit(function(event) {
                event.preventDefault();
                console.log("submit");
                $.ajax({
                    url: "http://localhost:3000/api/auth/login",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        email: $("#email").val(),
                        password: $("#password").val()
                    }),
                    xhrFields: {
                        withCredentials: true      // ⬅️ bắt buộc để gửi cookie
                    },
                    success: function(response) {
                        if(response.success) {
                            // Lưu token vào cookie (1 ngày)
                            setCookie('token', response.data.token, 1);
                            
                            // Lưu thông tin user vào cookie và localStorage
                            setCookie('userInfo', JSON.stringify(response.data.user), 1);
                            localStorage.setItem('user', JSON.stringify(response.data.user));
                            
                            showMessage(response.message, "success");
                            setTimeout(() => {
                                if(response.data.user.role === 'admin') {
                                    window.location.href = "/admin/home";
                                } else {
                                    window.location.href = "/";
                                }
                            }, 1500);
                        } else {
                            showMessage(response.message || "Đăng nhập thất bại", "error");
                        }
                    },
                    error: function(xhr) {
                        let msg = "Đã xảy ra lỗi trong quá trình đăng nhập";
                        if(xhr.responseJSON && xhr.responseJSON.message) {
                            msg = xhr.responseJSON.message;
                        }
                        showMessage(msg, "error");
                    }
                });
            });
        });
    </script>
</body>
       